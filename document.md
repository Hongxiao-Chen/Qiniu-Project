## **项目结构**

```
persona-chat/
├── backend/
│   ├── .env
│   ├── package.json
│   └── server.js
│
├── frontend/
│   ├── public/
│   │   ├── socrates.jpg
│   │   ├── harry.jpg
│   │   └── sherlock.jpg
│   ├── src/
│   │   ├── components/
│   │   │   ├── CharacterCard.jsx
│   │   │   ├── CharacterCard.css
│   │   │   ├── ChatInterface.jsx
│   │   │   └── ChatInterface.css
│   │   ├── pages/
│   │   │   ├── CharacterSelection.jsx
│   │   │   ├── CharacterSelection.css
│   │   │   ├── ChatPage.jsx
│   │   │   └── ChatPage.css
│   │   ├── App.jsx
│   │   ├── App.css
│   │   └── main.jsx
│   ├── .gitignore
│   ├── index.html
│   └── package.json
│
└── README.md
```

-----
## 架构设计文档

### 1. 高层架构概述


* **前端**: 单页应用，负责所有用户界面的渲染、用户交互（语音输入）的处理以及向后端发起 API 请求。
* **后端**: 一个 Node.js/Express 应用，提供 RESTful API 端点。

### 2. 前端模块规格

前端应用基于 React 组件化的思想构建，结构清晰，职责分明。

* **`main.jsx`**: **应用入口**。负责初始化 React 应用并包裹 `BrowserRouter` 来启用客户端路由。
* **`App.jsx`**: **顶层组件与路由配置**。定义了应用的整体布局（如页眉），并使用 `react-router-dom` 的 `<Routes>` 和 `<Route>` 组件来管理页面间的导航。
    * `'/'`: 指向 `CharacterSelection` 页面。
    * `'/chat/:characterId'`: 指向 `ChatPage` 页面。
* **`pages/CharacterSelection.jsx`**: **角色选择页**。
    * **职责**:
        1.  在组件加载时，调用后端 `/api/characters` 接口获取所有可用的角色列表。
        2.  提供一个搜索框，允许用户根据角色名进行实时筛选。
        3.  将筛选后的角色数据渲染成一系列 `CharacterCard` 组件。
* **`pages/ChatPage.jsx`**: **聊天页面容器**。
    * **职责**:
        1.  从 URL 参数中获取 `characterId`。
        2.  根据 `characterId` 调用后端 `/api/characters/:id` 接口获取特定角色的详细信息（包括名字、图片、描述等）。
        3.  将获取到的角色数据传递给核心的 `ChatInterface` 组件。
* **`components/CharacterCard.jsx`**: **角色卡片组件**。一个可复用的 UI 组件，用于展示单个角色的图片、名称和简介。整个卡片被一个 `<Link>` 包裹，点击后会导航到对应的聊天页面。
* **`components/ChatInterface.jsx`**: **核心聊天界面**。这是整个应用中逻辑最复杂的组件。
    * **职责**:
        1.  **状态管理**: 使用 `useState` 管理聊天记录 (`messages`)、麦克风状态 (`isListening`)、AI思考状态 (`isThinking`) 等。
        2.  **语音识别 (STT)**: 初始化并管理TTS API。处理用户的语音输入，将其转换为文本。
        3.  **音频控制**: 使用 `useRef` 控制一个隐藏的 `<audio>` 元素。负责播放 AI 的语音，以及在用户点击麦克风时**中断**当前播放的音频。
        4.  **API 调用**: 编排与后端的完整通信流程（获取文本 → 获取语音）。
        5.  **UI 渲染**: 将 `messages` 数组渲染成对话气泡流。

### 3. 后端模块规格

后端是一个单一的 Express 应用，提供了一组定义清晰的 API 端点。

* **`server.js`**: **服务器主文件**。
    * **职责**:
        1.  初始化 Express 应用，配置 CORS（跨域资源共享）中间件以允许前端访问。
        2.  加载并管理环境变量（API 密钥）。
        3.  定义所有 API 路由及其处理逻辑。
        4.  启动并监听指定端口。
* **角色数据与提示**: 在 `server.js` 内部，一个 `characters` 对象硬编码了所有角色的**系统指令 (System Prompt)**。这是实现角色特定技能的关键。
* **API 端点规格**:
    * `GET /api/characters`:
        * **描述**: 获取所有角色的列表（不含系统指令）。
        * **返回**: `200 OK` 与一个包含角色对象的 JSON 数组。
    * `GET /api/characters/:id`:
        * **描述**: 获取单个角色的详细信息。
        * **返回**: `200 OK` 与一个包含单个角色信息的 JSON 对象。`404 Not Found` 如果角色 ID 无效。
    * `POST /api/chat`:
        * **描述**: 接收前端发来的对话历史，并获取 AI 的下一步回复。
        * **请求体**: `{ characterId: string, history: object[] }`。
        * **处理流程**:
            1.  根据 `characterId` 查找对应的系统指令。
            2.  初始化 ChatGLM-Flash-4 模型，并将系统指令和 `history` 传入。
            3.  调用 ChatGLM API 生成文本回复。
            4.  将纯文本回复返回给前端。
        * **返回**: `200 OK` 与 `{ text: string }`。
    * `POST /api/tts`:
        * **描述**: 将一段文本转换为语音。
        * **请求体**: `{ text: string }`。
        * **处理流程**:
            1.  调用 `openai-edge-tts` API，将文本合成为 MP3 音频数据。
            2.  将音频数据保存为一个临时的、唯一的 MP3 文件到后端的 `public/audio` 目录。
            3.  返回该临时文件的可公开访问 URL。
            4.  设置一个定时器，在几分钟后自动删除该临时文件以节省空间。
        * **返回**: `200 OK` 与 `{ audioUrl: string }`。

## 思考题

* 你计划将这个网页面向什么类型的用户？这些类型的用户他们面临什么样的痛点，你设想的用户故事是什么样呢？
```
本网站主要面向角色/历史深度爱好者以及休闲娱乐者。这些用户共同的痛点在于，无论是书籍、影视还是学习资料，所提供的内容都是单向和被动的，他们缺乏一个能够主动参与、深度互动和获得情感连接的渠道。因此，我们的核心用户故事是：“作为一名特定领域的爱好者，我希望能随时与我崇拜的角色或历史人物进行一场自然的语音对话，从而沉浸式地体验他们的世界、深入理解他们的思想，并从中获得独特的陪伴感和乐趣。”
```
* 你认为这个网页需要哪些功能？这些功能各自的优先级是什么？你计划本次开发哪些功能？
```
必须具备（P0）的核心功能包括：角色搜索引擎、角色介绍与选择页、集成了语音识别(STT)与语音合成(TTS)的核心语音聊天界面，以及驱动对话的后端LLM引擎。应该具备（P1）的功能是用户账户系统和聊天历史记录。本次开发计划将完全聚焦于实现所有P0级别的“必须具备”功能，旨在打造一个最小可行产品，确保用户可以完整地体验到“搜索角色、选择角色、进行语音聊天”这一核心流程。
```
* 你计划采纳哪家公司的哪个 LLM 模型能力？你对比了哪些，你为什么选择用该 LLM 模型？
```
本网站采纳智谱AI的ChatGLM-Flash-4。其核心优势在于：首先，它提供了免费的API服务，极大地降低了开发和运营成本；其次，该模型针对中文语境进行了深度优化，在理解和生成中文方面表现更为出色，能更好地塑造角色的语言风格；最后，其服务在国内可以直接访问，无需特殊网络设置，这不仅确保了开发流程的顺畅，也为用户提供了更稳定、低延迟的访问体验。
```
* 你期望 AI 角色除了语音聊天外还应该有哪些技能？
```
除了基础的语音聊天，我期望AI角色能拥有与其身份背景深度绑定的独特“技能”，以提升交互的沉浸感和独特性。例如，我期望苏格拉底拥有“追问思辨”的技能，他不会直接给出答案，而是通过不断反问来引导用户思考。对于哈利·波特这样的角色，我期望他具备“回忆叙事”的技能，能在被问及时以第一人称生动地讲述一段魔法世界的经历。而对于福尔摩斯，则应该具备“演绎推理”的技能，能基于对话中的蛛丝马迹，对用户本人做出一番合乎逻辑的推断。
```